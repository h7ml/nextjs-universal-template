name: Cleanup Failed Workflow Runs

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼ˆUTCï¼‰
  schedule:
    - cron: "0 2 * * *"
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      days:
        description: "ä¿ç•™æœ€è¿‘ N å¤©çš„è¿è¡Œè®°å½•ï¼ˆé»˜è®¤ 7 å¤©ï¼‰"
        required: false
        default: "7"
        type: string
      dry_run:
        description: "ä»…æ˜¾ç¤ºè€Œä¸å®é™…åˆ é™¤ï¼ˆdry runï¼‰"
        required: false
        default: true
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      # éœ€è¦è¯»å–å’Œåˆ é™¤å·¥ä½œæµè¿è¡Œçš„æƒé™
      actions: write
    steps:
      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åœ¨ GitHub Actions ä¸­ï¼ŒGITHUB_TOKEN æ˜¯è‡ªåŠ¨åˆ›å»ºçš„ secret
          # GitHub CLI ä¼šè‡ªåŠ¨è¯»å– GH_TOKEN ç¯å¢ƒå˜é‡
          echo "âœ… GitHub CLI å·²é€šè¿‡ GITHUB_TOKEN è®¤è¯"

      - name: Set cleanup parameters
        id: params
        run: |
          DAYS="${{ github.event.inputs.days || '7' }}"
          # å¤„ç† boolean è¾“å…¥ï¼ˆGitHub Actions è¿”å› true/false å­—ç¬¦ä¸²ï¼‰
          DRY_RUN_INPUT="${{ github.event.inputs.dry_run || 'true' }}"
          if [ "$DRY_RUN_INPUT" == "true" ]; then
            DRY_RUN="true"
          else
            DRY_RUN="false"
          fi
          echo "days=$DAYS" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
          echo "ä¿ç•™æœ€è¿‘ $DAYS å¤©çš„è¿è¡Œè®°å½•"
          if [ "$DRY_RUN" == "true" ]; then
            echo "ğŸ” ä»…æ˜¾ç¤ºæ¨¡å¼ï¼ˆä¸ä¼šå®é™…åˆ é™¤ï¼‰"
          else
            echo "ğŸ—‘ï¸  åˆ é™¤æ¨¡å¼ï¼ˆå°†å®é™…åˆ é™¤ï¼‰"
          fi

      - name: Get failed workflow runs
        id: get-failed-runs
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DAYS="${{ steps.params.outputs.days }}"
          # GitHub Actions è¿è¡Œåœ¨ Ubuntuï¼Œä½¿ç”¨ Linux date æ ¼å¼
          CUTOFF_DATE=$(date -u -d "$DAYS days ago" +"%Y-%m-%dT%H:%M:%SZ")

          echo "æŸ¥æ‰¾ $CUTOFF_DATE ä¹‹å‰çš„å¤±è´¥è¿è¡Œ..."

          # è·å–æ‰€æœ‰å¤±è´¥çš„å·¥ä½œæµè¿è¡Œï¼ˆä¸ä½¿ç”¨ --jqï¼Œæ‰‹åŠ¨è¿‡æ»¤ï¼‰
          gh run list \
            --repo ${{ github.repository }} \
            --limit 100 \
            --json databaseId,conclusion,createdAt,displayTitle,workflowName \
            > /tmp/all-runs.json

          # ä½¿ç”¨ jq è¿‡æ»¤å¤±è´¥çš„è¿è¡Œ
          jq "[.[] | select(.conclusion == \"failure\" and (.createdAt < \"$CUTOFF_DATE\"))]" \
            /tmp/all-runs.json > /tmp/failed-runs.json

          # æ£€æŸ¥ç»“æœ
          RUN_COUNT=$(jq '. | length' /tmp/failed-runs.json)
          
          if [ "$RUN_COUNT" -eq 0 ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¸…ç†çš„å¤±è´¥è¿è¡Œ"
            echo "runs_to_delete=[]" >> $GITHUB_OUTPUT
          else
            echo "æ‰¾åˆ° $RUN_COUNT ä¸ªå¤±è´¥çš„è¿è¡Œ"
            echo "runs_to_delete=$(jq -c '[.[].databaseId]' /tmp/failed-runs.json)" >> $GITHUB_OUTPUT
            jq -r '.[] | "  - \(.displayTitle) (\(.workflowName)) - \(.createdAt)"' /tmp/failed-runs.json
          fi

      - name: Delete failed runs
        if: steps.get-failed-runs.outputs.runs_to_delete != '[]' && steps.get-failed-runs.outputs.runs_to_delete != ''
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DRY_RUN="${{ steps.params.outputs.dry_run }}"

          if [ "$DRY_RUN" == "true" ]; then
            echo "ğŸ” ä»…æ˜¾ç¤ºæ¨¡å¼ï¼šä»¥ä¸‹è¿è¡Œå°†è¢«åˆ é™¤ï¼ˆä½†ä¸ä¼šå®é™…æ‰§è¡Œï¼‰"
            cat /tmp/failed-runs.json | jq -r '.[] | "  - Run ID: \(.databaseId) - \(.displayTitle)"'
          else
            echo "ğŸ—‘ï¸  å¼€å§‹åˆ é™¤å¤±è´¥çš„è¿è¡Œ..."

            # è¯»å–è¦åˆ é™¤çš„è¿è¡Œ ID
            RUN_IDS=$(cat /tmp/failed-runs.json | jq -r '.[].databaseId')

            DELETED=0
            FAILED=0

            for RUN_ID in $RUN_IDS; do
              if gh api \
                --method DELETE \
                "/repos/${{ github.repository }}/actions/runs/$RUN_ID"; then
                echo "âœ… å·²åˆ é™¤è¿è¡Œ: $RUN_ID"
                DELETED=$((DELETED + 1))
              else
                echo "âŒ åˆ é™¤å¤±è´¥: $RUN_ID"
                FAILED=$((FAILED + 1))
              fi
            done

            echo "ğŸ“Š åˆ é™¤å®Œæˆï¼šæˆåŠŸ $DELETED ä¸ªï¼Œå¤±è´¥ $FAILED ä¸ª"
          fi

      - name: Summary
        run: |
          DRY_RUN="${{ steps.params.outputs.dry_run }}"
          DAYS="${{ steps.params.outputs.days }}"

          if [ "$DRY_RUN" == "true" ]; then
            echo "## ğŸ” æ¸…ç†é¢„è§ˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ¨¡å¼**: ä»…æ˜¾ç¤ºï¼ˆDry Runï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ğŸ—‘ï¸  æ¸…ç†ç»“æœ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ¨¡å¼**: å®é™…åˆ é™¤" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¿ç•™å¤©æ•°**: $DAYS å¤©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f /tmp/failed-runs.json ]; then
            RUN_COUNT=$(cat /tmp/failed-runs.json | jq '. | length')
            echo "**æ‰¾åˆ°çš„å¤±è´¥è¿è¡Œ**: $RUN_COUNT ä¸ª" >> $GITHUB_STEP_SUMMARY

            if [ "$RUN_COUNT" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### è¿è¡Œåˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| å·¥ä½œæµ | æ ‡é¢˜ | åˆ›å»ºæ—¶é—´ |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|------|----------|" >> $GITHUB_STEP_SUMMARY
              cat /tmp/failed-runs.json | jq -r '.[] | "| \(.workflowName) | \(.displayTitle) | \(.createdAt) |"' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**æ‰¾åˆ°çš„å¤±è´¥è¿è¡Œ**: 0 ä¸ª" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… æ— éœ€æ¸…ç†" >> $GITHUB_STEP_SUMMARY
          fi
